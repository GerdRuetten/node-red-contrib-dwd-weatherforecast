<!-- ===== Edit-Dialog Template ===== -->
<script type="text/html" data-template-name="dwd-weatherforecast">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="optional">
    </div>

    <div class="form-row">
        <label for="node-input-station"><i class="fa fa-map-marker"></i> DWD Stations-ID</label>
        <input type="text" id="node-input-station" placeholder="z. B. H721 (Köln/Bonn)">
        <div class="form-tips">
            <a href="https://www.dwd.de/DE/leistungen/klimadatendeutschland/statliste/statlex_html.html" target="_blank">
                Liste der DWD Stations-IDs anzeigen
            </a>
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-sourceUrl"><i class="fa fa-link"></i> Source-URL</label>
        <input type="text" id="node-input-sourceUrl" placeholder="Template mit {station}">
        <div class="form-tips">
            Standard: <code>https://opendata.dwd.de/weather/local_forecasts/mos/MOSMIX_L/single_stations/{station}/kml/MOSMIX_L_LATEST_{station}.kmz</code>
            (Platzhalter <code>{station}</code> wird ersetzt).
        </div>
    </div>

    <hr>

    <div class="form-row">
        <label for="node-input-fetchOnDeploy"><i class="fa fa-refresh"></i> Beim Deploy abrufen</label>
        <input type="checkbox" id="node-input-fetchOnDeploy">
        <div class="form-tips">Daten direkt beim DWD abrufen.</div>
    </div>

    <div class="form-row">
        <label for="node-input-autoRefresh"><i class="fa fa-clock-o"></i> Auto-Refresh (Sek.)</label>
        <input type="number" id="node-input-autoRefresh" min="0" max="86400" step="1">
        <div class="form-tips">0 = kein automatisches Nachladen.</div>
    </div>

    <div class="form-row">
        <label for="node-input-maxHours"><i class="fa fa-hourglass-half"></i> Vorlauf (Std.)</label>
        <input type="number" id="node-input-maxHours" min="0" max="240" step="1" placeholder="0 = alle">
        <div class="form-tips">Begrenzt die Vorhersage zeitlich (z. B. 24 = nur die nächsten 24 Stunden).</div>
    </div>

    <div class="form-row">
        <label for="node-input-staleOnError"><i class="fa fa-undo"></i> Fallback</label>
        <input type="checkbox" id="node-input-staleOnError">
        <div class="form-tips">Bei Fehler letzte erfolgreiche Daten senden (stale).</div>
    </div>

    <div class="form-row">
        <label for="node-input-onlyFuture"><i class="fa fa-filter"></i> Nur zukünftige Zeitpunkte</label>
        <input type="checkbox" id="node-input-onlyFuture">
        <div class="form-tips">Historischen Daten werden herausgefiltert.</div>
    </div>

    <hr>

    <div class="form-row">
        <label><i class="fa fa-balance-scale"></i> Ausgabe-Optionen</label>
    </div>
    <div class="form-row">
        <label for="node-input-coreOnly">Nur Kernfelder</label>
        <input type="checkbox" id="node-input-coreOnly">
    </div>
    <div class="form-row">
        <label for="node-input-toC">Temperatur in °C</label>
        <input type="checkbox" id="node-input-toC" checked>
    </div>
    <div class="form-row">
        <label for="node-input-windToKmh">Windgeschwindigkeit in km/h</label>
        <input type="checkbox" id="node-input-windToKmh" checked>
    </div>
    <div class="form-row">
        <label for="node-input-pressureToHpa">Druck in hPa</label>
        <input type="checkbox" id="node-input-pressureToHpa" checked>
    </div>
    <div class="form-row">
        <label for="node-input-visibilityToKm">Sichtweite in km</label>
        <input type="checkbox" id="node-input-visibilityToKm" checked>
    </div>

    <hr>

    <div class="form-row">
        <label for="node-input-diag"><i class="fa fa-bug"></i> Diagnose aktivieren</label>
        <input type="checkbox" id="node-input-diag">
    </div>

    <hr>
    <div class="form-tips">
        <b>Hinweis:</b> Datenquelle ist die DWD MOSMIX-Vorhersage (L-Version). Aktualisierung idR stündlich.
        Mehr Infos: <a href="https://www.dwd.de/DE/leistungen/opendata/opendata.html" target="_blank">DWD Open Data</a>.
    </div>
</script>

<!-- ===== Help-Tab ===== -->
<script type="text/markdown" data-help-name="dwd-weatherforecast">
    **DWD-Weatherforecast**
    Liest die DWD MOSMIX-Vorhersage für eine Station (z. B. **H721**) aus dem KMZ/KML-Feed,
    parst die Zeitreihen und gibt sie als JSON-Serie aus.

    **Wichtige Felder:**
    - *Stations-ID* (z. B. H721).
    - *Source-URL*: Template mit `{station}`-Platzhalter (Standard ist vorbelegt).
    - *Beim Deploy abrufen*, *Auto-Refresh (Sek.)* und *Vorlauf (Stunden)* steuern Abruf & Umfang.
    - *Nur Kernfelder* liefert kompakten Payload. Umrechnungen schalten Einheiten um (°C, km/h, hPa, km).
    - *Diagnose aktivieren* schreibt zusätzliche Logs in die Node-RED-Konsole.
</script>

<!-- ===== Registrierung ===== -->
<script type="text/javascript">
    (function() {
        RED.nodes.registerType("dwd-weatherforecast", {
            category: "DWD",
            color: "#4C8EDA",
            icon: "font-awesome/fa-cloud",
            inputs: 1,
            outputs: 1,
            defaults: {
                name:        { value: "" },
                station:     { value: "", required: true },
                sourceUrl:   { value: "https://opendata.dwd.de/weather/local_forecasts/mos/MOSMIX_L/single_stations/{station}/kml/MOSMIX_L_LATEST_{station}.kmz" },
                fetchOnDeploy:{ value: true },
                autoRefresh: { value: 0 },
                maxHours:    { value: 0 },
                coreOnly:    { value: false },
                toC:         { value: true },
                windToKmh:   { value: true },
                pressureToHpa:{ value: true },
                visibilityToKm:{ value: true },
                diag:        { value: false },
                staleOnError: { value: false },
                onlyFuture: { value: true }
            },
            label: function() {
                return this.name || "DWD-Weatherforecast";
            },
            oneditprepare: function() {
                $("#node-input-autoRefresh").attr({ min: 0, max: 86400, step: 1 });
                $("#node-input-maxHours").attr({ min: 0, max: 240, step: 1 });
            }
        });
    })();
</script>

<style>
    .form-row label {
        width: 180px;
        display: inline-block;
    }
    .form-tips {
        font-size: 0.85em;
        color: #666;
        margin-left: 180px;
        line-height: 1.4em;
    }
</style>